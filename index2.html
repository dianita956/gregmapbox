<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mapping: El Corrido de Gregorio Cortez</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.8.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.8.0/mapbox-gl.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        #map { position: fixed; top: 0; bottom: 0; width: 50%; }
        #features {
            width: 50%;
            margin-left: 50%;
            font-family: sans-serif;
            background-color: #fafafa;
        }
        section {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            font-size: 14px;
        }
        section.active { 
            background-color: #f0f8ff;
        }
        section:last-child {
            margin-bottom: 200px;
        }
        .news-image img {
            width: 100%;  /* Make the image fill the container width */
            height: auto; /* Maintain aspect ratio */
            max-width: 50vw;  /* Limit the maximum width of the image */
        }
        .marker {
            background-image: url('https://docs.mapbox.com/demos/custom-markers-gl-js/mapbox-icon.png');
            background-size: cover;
            width: 50px;
            height: 50px;
            cursor: pointer;
        }
        .audio-player {
            margin: 10px;
        }
        .inline-audio-player {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .text-audio-wrapper {
            display: inline;
            align-items: center;
            font-family: Verdana, Geneva, Tahoma, sans-serif;
        }

        .play-btn {
            padding: 5px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 5px;
            
        }
         .audio-text {
            transition: background-color 0.3s ease;
            line-height: 1.5; 
        }

        .audio-text.active {
            background-color: rgba(0, 229, 255, 0.729); /* Highlight text */
        }
        .stanzas {
            font-family: Verdana, Geneva, Tahoma, sans-serif;
            line-height: 1.5;
        }
        #reset-map-view {
            background-color: #0074D9;
            color: white;
            border: none;
            padding: 10px 15px;
            font-size: 14px;
            border-radius: 5px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        #reset-map-view:hover {
            background-color: #0056A3;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="features"></div>
    <div class="audio-player"></div>
    <button id = 'reset-map-view'style="position: fixed; top: 10px; right: 10px; z-index: 1000;">Reset Map View</button>

    <script>
// Mapbox setup
        mapboxgl.accessToken = 'pk.eyJ1IjoiZGlhbml0YTk1NiIsImEiOiJjbTNuamNzam0wdHRrMmxxMW81MHMxMTdpIn0.-1QhN4HjJq36viH82gJUtg'; // Replace with your Mapbox access token
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v12',
            center: [-98.3, 28.5],
            zoom: 7
        });

//reset map view
        document.getElementById('reset-map-view').addEventListener('click', () => {
                    map.flyTo({
                        center: [-98.3, 28.5], // Your initial center coordinates
                        zoom: 7, // Your initial zoom level
                        essential: true // Ensures smooth animation
                    });
                });
// hard code data
        const data = {
            "type": "FeatureCollection",
            "name": "gdf",
            "crs": {
                "type": "name",
                "properties": {
                    "name": "urn:ogc:def:crs:OGC:1.3:CRS84"
                }
            },
            "features": [
                {
                    "type": "Feature",
                    "id": 1,
                    "properties": {
                        "address": "Karnes County, Texas",
                        "Latitude": 28.8791858,
                        "Longitude": -97.9062893
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [-97.9062893, 28.8791858]
                    },
                    "content": {
                        "stanzas":{
                            "es": "En el condad de Carnes. \nmiren lo que ha sucedido,\nmurió el Cherife Mayor. \nquednado Roman herido",
                            "en": "In the county of Karnes, \nLook what has happened; \nThe Major Sheriff died, \nLeaving Román badly wounded.",
                         },
                        "audioFile":"audio/GC 1 Mixdown.mp3",
                        "articleImg": "articleImg/Cortez_is_in_Bexar_Jail._the_Slayer_of_Sheriffs__San_Antonio_Express_published_as_The_Daily_Express___June_25_1901__p1_4.png",
                        "articleLink": "articleImg/Cortez_is_in_Bexar_Jail._the_Slayer_of_Sheriffs__San_Antonio_Express_published_as_The_Daily_Express___June_25_1901__p1_4.pdf"
                    }
                },
                {
                    "type": "Feature",
                    "id": 2,
                    "properties": {
                        "address": "Gonzales County, Texas",
                        "Latitude": 29.4436555,
                        "Longitude": -97.5108636
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [
                            -97.5108636,
                            29.4436555
                        ]
                    },
                    "content":{
                        "stanzas":{
                            "es":"Tiró con rumbo a Gonzales \nsin ninguna timidez:\n--Síganme rinches cobardes, \nyo soy Gregorio Cortez.",
                            "en": "He struck out for Gonzales \nWithout showing any fear, \n'Follow me, cowardly rangers, \nI am Gregorio Cortez.'",
                        },
                        "audioFile":"audio/GC 10Mixdown.mp3",
                        "articleImg": "articleImg/Hot_on_His_Trail__Dallas_Morning_News__June_18_1901__p1.png",
                        "articleLink": "articleImg/Hot_on_His_Trail__Dallas_Morning_News__June_18_1901__p1.pdf"

                    }
                },
                {
                    "type": "Feature",
                    "id": 3,
                    "properties": {
                        "address": "Belmont, Gonzalez County, Texas",
                        "Latitude": 29.5241066,
                        "Longitude": -97.6875125
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [
                            -97.6875125,
                            29.5241066
                        ]
                    },
                    "content": {
                        "stanzas":{
                            "es": "Se fue de Belmont al rancho, \nlo alacanzaron a rodear, \npoquitos más de trescientos, \ny allí les brincó el corral.",
                            "en": "From Belmont he went to the ranch,\nThey succeeded in surrounding him, \nQuite a few more than three hundred,\nBut there he jumped their corral.",
                        },
                        "audioFile":"audio/GC 11 Mixdown.mp3",
                        "articleImg": "articleImg/Officers_on_Hot_Trails._Many_Determined_Men_Are_in__San_Antonio_Express_published_as_The_Daily_Express___June_18_1901__p1_2.png",
                        "articleLink":"articleImg/Officers_on_Hot_Trails._Many_Determined_Men_Are_in__San_Antonio_Express_published_as_The_Daily_Express___June_18_1901__p1_2.pdf"

                    }
                },
                {
                    "type": "Feature",
                    "id": 4,
                    "properties": {
                        "address": "Laredo, Texas",
                        "Latitude": 27.5075005,
                        "Longitude": -99.5069922
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [
                            -99.5069922,
                            27.5075005
                        ]
                    },
                    "content": {
                        "stanzas":{
                            "es": "Salió Gregorio Cortez, \nsalió con rumbo a Laredo, \nno lo quisieron seguir \nporque le tuvieron miedo.",
                            "en": "Gregorio Cortez went out, \nHe went towards Laredo \nThey decided not to follow \nBecause they were afraid of him.",
                        },
                        "audioFile":"audio/GC 14Mixdown.mp3",
                        "articleImg": "articleImg/Cortez_Has_Been_Identified._William_Loueary_and__San_Antonio_Express_published_as_The_Daily_Express___June_24_1901__p1_2.png",
                        "articleLink":"articleImg/Cortez_Has_Been_Identified._William_Loueary_and__San_Antonio_Express_published_as_The_Daily_Express___June_24_1901__p1_2.pdf"

                    }
                },
                {
                    "type": "Feature",
                    "id": 5,
                    "properties": {
                        "address": "Encinal, Texas",
                        "Latitude": 28.0406329,
                        "Longitude": -99.3552096
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [
                            -99.3552096,
                            28.0406329
                        ]
                    },
                    "content": {
                        "stanzas":{
                            "es": "Allá por El Encinal, \nsegún lo que aquí se dice, \nle formaron un corral y les mató otro cherife.",
                            "en": "Over by El Encinal,\nAccording to what we hear, \nThey made him a corral, \n And he killed them another sheriff.",
                        },
                        "audioFile":"audio/GC 17 Mixdown.mp3",
                        "articleImg": "articleImg/Cortez_Eludes_Pursuers_Wily_Fugitive_Seems_to_Have__San_Antonio_Express_published_as_The_Daily_Express___June_22_1901__p1_2.png",
                        "articleLink":"articleImg/Cortez_Eludes_Pursuers_Wily_Fugitive_Seems_to_Have__San_Antonio_Express_published_as_The_Daily_Express___June_22_1901__p1_2.pdf"

                    }
        }
            ]
        };

// Create marker on the map
            //store markers
            const markers= {};
            

            //function to create markers
            function createMarker(feature){
                const marker = new mapboxgl.Marker({
                    color: 'black'
                })
                //.setLngLat([feature.geometry.coordinates[0], feature.geometry.coordinates[1]]) (Delete = D)
                //.setPopup(new mapboxgl.Popup().setHTML(`(D)
                //<h3>${feature.properties.address}</h> (D)
                    //${feature.content.audioFile ? createAudioPlayer(feature) : ''} (D)
                    //<p class="stanza">${feature.content.stanzas.en}</p>(D)
                    //`))(D)
                .setLngLat(feature.geometry.coordinates)
                .setPopup(new mapboxgl.Popup().setHTML(createPopUpContent(feature)))
                    .addTo(map);

                    markers[feature.id] = marker;
            }

//Create dynamic scroll content and markers
        function createPopUpContent(feature){
            return `
            <h3>${feature.properties.address}</h3>
            ${feature.content.audioFile ? createAudioPlayer(feature) : ''}
            <p class= "stanza"${feature.content.stanzas.en}</p>
        `;
        }

        data.features.forEach((feature) => {
            //new: create a marker for each feature
            createMarker(feature);
            createScrollContent(feature);
        });

        // create dynamic scroll content for each feature
        function createScrollContent(feature){
            const { address } = feature.properties;
            const { stanzas, audioFile, articleImg, articleLink } = feature.content;

            const section = document.createElement('section');
            section.id = feature.id;
            section.innerHTML = `
                <h1>${feature.properties.address}</h1>
                ${createAudioPlayer(feature, 'es')}
                <p class="stanzas">${feature.content.stanzas.en}</p>
                <p><a href="${feature.content.articleLink}" target="_blank">Read full article</a></p>
                <div class="news-image">
                    <img src="${feature.content.articleImg}" alt="Article Image">
                </div>
            `;
            console.log(section.innerHTML);
            document.getElementById('features').appendChild(section);
        }

//Synchronize map with scrolling
        const chapters = data.features.reduce((acc, feature) => {
            acc[feature.id] = {
                center: feature.geometry.coordinates,
                zoom: 10
            };
            return acc;
        }, {});

        let activeChapterName = data.features[0].id;
        let activeAudio=null; //var to track the active audio element

        //set active chapter sectiion
        function setActiveChapter(chapterName) {
            if (chapterName === activeChapterName) return;

            resetActiveAudio();
            map.flyTo(chapters[chapterName]);
            updateActiveMarker(chapterName);
            updateActiveSection(chapterName);
            activeChapterName = (chapterName);
        }
            //pause and reset the active audio if any
            function resetActiveAudio(){
            if (activeAudio && !activeAudio.paused) {
                activeAudio.pause();
                activeAudio.currentTime = 0;
                const playButton = document.querySelector(`button[onclick*="${activeAudio.id}"]`);
                if (playButton) playButton.textContent = "play"; //reset button text
            }
            //map.flyTo(chapters[chapterName]); (delete = D)
        }
            //note: change marker colors
        function updateActiveMarker(chapterName){
            if (markers[activeChapterName]) {
                markers[activeChapterName].getElement().style.backgroundColor = '';
            }
            if (markers[chapterName]){
                markers[activeChapterName].getElement().style.backgroundColor = 'red'; //set previous marker background to red
            }
        }            
            // highlist the active section and marker
        function updateActiveSection(chapterName){
            document.getElementById(chapterName).classList.add('active');
            document.getElementById(activeChapterName).classList.remove('active');
            //set new active chapter and update marker color(delete)
            //markers[chapterName].getElement().style.backgroundColor = '#00ff00'; //(green)(D)
            //activeChapterName = chapterName;(D)
            }   
        
        // Scroll event listener
        window.onscroll = () => {
            for (const feature of data.features) {
                if (isElementOnScreen(feature.id)) {
                    setActiveChapter(feature.id);
                    break;
                }
            }
        };
        // Function to check if the section is in the viewport
        function isElementOnScreen(id) {
            const element = document.getElementById(id);
            const bounds = element.getBoundingClientRect();
            return bounds.top < window.innerHeight && bounds.bottom > 0;
            }

        function toggleAudio(audioSrc, audioId) {
            const audio = document.getElementById(audioId);
            const playButton = document.querySelector(`button[onclick="toggleAudio('${audioSrc}', '${audioId}')"]`);

            if (audio.paused) {
                //pause any active audio before playing a new one(D)
                //if (activeAudio && activeAudio!== audio){(D)
                    //activeAudio.pause();(D)
                    //activeAudio.currentTime = 0;(D)
                    //const previousPlayButton = document.querySelector(`button[onclick*="${activeAudio.id}"]`);(D)
                    //if (previousPlayButton) previousPlayButton.textContent = 'play';(D)
                //}
                resetActiveAudio();
                audio.play();
                playButton.textContent = "Pause";
                activeAudio = audio; //set the active audio
                
                //const textWrapper = playButton.nextElementSibling;(D)
                //const spans = textWrapper.querySelectorAll(".audio-text");(D)

                //audio.ontimeupdate = () => {(D)
                    //spans.forEach(span => {(D)
                        //const start = parseFloat(span.dataset.start);(D)
                        //const end = parseFloat(span.dataset.end);(D)
                        //span.classList.toggle("active", audio.currentTime >= start && audio.currentTime <= end);(D)
                    //});(D)
                //};(D)

                //audio.onended = () => {(D)
                    //playButton.textContent = "Play";(D)
                //};
                syncAudioWithText(audio, playButton);
            } else {
                audio.pause();
                playButton.textContent = "play";
            }
        }
        function syncAudioWithText(audio, spans) {
            //const textWrapper = playButton.nextElementSibling;
            //const spans = textWrapper.querySelectorAll(".audio-text");

            audio.ontimeupdate = () => {
                spans.forEach(span => {
                    const start = parseFloat(span.dataset.start);
                    const end = parseFloat(span.dataset.end);
                    span.classList.toggle("active", audio.currentTime >= start && audio.currentTime <= end);
                });
            };

            audio.onended = () => {
                spans.forEach(span => span.classList.remove("active"));
                //playButton.textContent = "Play";(D)
            };
        }

        function createAudioPlayer(feature, language ='es') {
            const stanzaLines = feature.content.stanzas[language].split('\n');
            const startTimes = [5, 11,17, 23]; // Adjust timing based on your data for the highlight of each line
            const endTimes = [10, 16, 22, 30]; // Adjust timing based on your data for the highlight of each line

            let stanzaSpans = '';
            stanzaLines.forEach((line, index) => {
                stanzaSpans += `
                    <span class="audio-text" data-start="${startTimes[index]}" data-end="${endTimes[index]}">${line}</span>
                `;
            });
            //inline audio player html
            return `
                <div class="inline-audio-player">
                    <div class="text-audio-wrapper">
                        <button class="play-btn" onclick="toggleAudio('${feature.content.audioFile}', 'popup-audio-${feature.id}')">Play</button>
                        <p class="audio-text-wrapper">
                            ${stanzaSpans}
                        </p>
                    </div>
                    <audio id="popup-audio-${feature.id}" src="${feature.content.audioFile}" hidden></audio>
                </div>
            `;
        }
    </script>
</body>
</html>
